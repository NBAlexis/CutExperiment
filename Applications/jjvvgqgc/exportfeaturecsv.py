import os
import re

import numpy as np

from Applications.jjvvgqgc.jjvvfunctions import PTMissing
from CutAndExport.FilterFunctions import Mjj2Filter
from DataStructure.EventSet import EventSet
from Interfaces.LHCOlympics import LoadLHCOlympics

os.chdir("../../_DataFolder/jjvv")


def exportMjjAndPtForSample(events: EventSet):
    retarray = []
    for sample in events.events:
        jetCount = 0
        for particle in sample.particles:
            if 4 == particle.particleType:
                jetCount += 1
        if jetCount < 2:
            continue
        mjj = Mjj2Filter(sample)
        pt = PTMissing(sample)
        retarray.append([mjj, pt])
    return retarray

# """
headers = "fgt0"
energy = "1500"
numberOfInput = 1

cslist = []
coeflist = []
for i in range(0, 11):
    fileNameLHCO = "Scan/" + headers + "/" + energy + "/" + headers + "-" + energy + "-" + str(i) + ".lhco"
    fileNameBanner = "Scan/" + headers + "/" + energy + "/" + headers + "-" + energy + "-" + str(i) + "-banner.txt"
    fileNameSave = "ScanFeatures/" + headers + "/" + energy + "/" + headers + "-" + energy + "-" + str(i) + ".csv"
    with open(fileNameBanner, "r") as f:
        data = f.read()
        # Integrated weight (pb)  :       0.8721577408
        pattern = r"\#[\s]+Integrated weight \(pb\)[\s]+:[\s]+([\d]*\.[\d]*)"
        x = re.search(pattern, data)
        cs = float(x.group(1))
        cslist.append(cs)
        # BLOCK ANOINPUTS #
        # 1 -1e-12 #
        pattern = r"BLOCK ANOINPUTS \#[\s\d\-\+\#\.fgte]+" + str(numberOfInput) + r" ([\d\+\-\.e]+)"
        x = re.search(pattern, data)
        coeff = float(x.group(1))
        coeflist.append(coeff)
    eventSets = LoadLHCOlympics(fileNameLHCO)
    tobeSaved = np.array(exportMjjAndPtForSample(eventSets))
    np.savetxt(fileNameSave, tobeSaved, delimiter=',')
    print(fileNameSave + " saved!")

print(cslist)
print(coeflist)
# """

"""
filenames = ["fgt0-1500", "fgt0-5000", "fgt0-7000", "fgt0-15000",
             "fgt1-1500", "fgt1-5000", "fgt1-7000", "fgt1-15000",
             "fgt2-1500", "fgt2-5000", "fgt2-7000", "fgt2-15000",
             "fgt3-1500", "fgt3-5000", "fgt3-7000", "fgt3-15000",
             "sm1500", "sm5000", "sm7000", "sm15000"]

for file in filenames:
    fileNameLHCO = "Feature/" + file + ".lhco"
    fileNameCSV = "ScanFeatures/feature/" + file + ".csv"
    eventSets = LoadLHCOlympics(fileNameLHCO)
    tobeSaved = np.array(exportMjjAndPtForSample(eventSets))
    np.savetxt(fileNameCSV, tobeSaved, delimiter=',')
    print(fileNameCSV + " saved!")

"""

"""
fgt0

1500:
[0.8719412347, 0.8709946998000003, 0.8698208609, 0.8690046429999999, 0.868756013, 0.8683596632000004, 0.8689100580000002, 0.8692242346000002, 0.8697591184999999, 0.8706435678000001, 0.8720257528]
[-1e-12, -8e-13, -6e-13, -3.999999999999999e-13, -1.9999999999999996e-13, 0.0, 2.0000000000000016e-13, 4.000000000000001e-13, 6.000000000000001e-13, 8e-13, 1e-12]
5000:
[1.4566739132600006, 1.45587120176, 1.4552756202, 1.45474752603, 1.4550055830300002, 1.4545246348199998, 1.4549125210199998, 1.4553909578199997, 1.4553781231999998, 1.4556332797999998, 1.45659646559]
[-1.2e-14, -9.6e-15, -7.2e-15, -4.799999999999999e-15, -2.3999999999999996e-15, 0.0, 2.400000000000001e-15, 4.799999999999999e-15, 7.2e-15, 9.600000000000001e-15, 1.2e-14]
7000:
[1.60985727289, 1.6092913330500003, 1.60897092719, 1.6089300213199997, 1.6082524030999996, 1.6092715916299998, 1.60874968461, 1.6085007018400004, 1.60894364454, 1.6089110751600004, 1.6095329166500003]
[-4e-15, -3.2000000000000003e-15, -2.4000000000000003e-15, -1.6000000000000004e-15, -8.000000000000004e-16, 0.0, 8e-16, 1.6e-15, 2.4e-15, 3.2e-15, 4e-15]
15000:
[1.9005688823299995, 1.8994425780300002, 1.89960423276, 1.8995333162300003, 1.8997088977800003, 1.8984457019500003, 1.89988325513, 1.8987465588899999, 1.8985808688699997, 1.8994951561999995, 1.8994669836000002]
[-3.5e-16, -2.8e-16, -2.1e-16, -1.4e-16, -7e-17, 0.0, 7e-17, 1.4000000000000006e-16, 2.1e-16, 2.7999999999999996e-16, 3.5e-16]

fgt1

1500:
[0.8724171688, 0.8716425186, 0.8698007867, 0.8693070012000002, 0.8684921682999999, 0.8689588463999999, 0.8688539883999999, 0.8694224412999998, 0.8698821808, 0.8713736276999999, 0.8724000226]
[-1.5e-12, -1.2000000000000001e-12, -9.000000000000001e-13, -6.000000000000001e-13, -3.0000000000000014e-13, -2.0194839173657902e-28, 2.9999999999999993e-13, 5.999999999999999e-13, 9e-13, 1.1999999999999997e-12, 1.4999999999999997e-12]

5000:
[1.45676474983, 1.4559586770300001, 1.4557095738100003, 1.45485637883, 1.45514440369, 1.4549129190100003, 1.4554327709500001, 1.4557426551400003, 1.45589129595, 1.4550941900199998, 1.4560194733800003]
[-2e-14, -1.6e-14, -1.2e-14, -7.999999999999999e-15, -3.999999999999999e-15, 3.1554436208840472e-30, 4.000000000000002e-15, 8e-15, 1.2000000000000003e-14, 1.6000000000000004e-14, 2.0000000000000006e-14]

7000:
[1.60984105391, 1.6095613539600004, 1.6095289347700001, 1.60853574515, 1.6087724719299994, 1.6083979168200002, 1.6083106133999998, 1.6086369141800003, 1.6090405078500003, 1.6085064291100002, 1.6098328497900005]
[-7e-15, -5.6e-15, -4.2000000000000004e-15, -2.7999999999999997e-15, -1.3999999999999999e-15, 0.0, 1.4000000000000007e-15, 2.7999999999999997e-15, 4.2000000000000004e-15, 5.600000000000001e-15, 7e-15]

15000:
[1.9012798680699998, 1.8995170955699998, 1.9003777560600001, 1.8975502548529999, 1.8985813481099998, 1.89843048006, 1.9002632060200002, 1.8998698377299998, 1.89914411282, 1.8995842688899998, 1.8991643848199997]
[-6e-16, -4.8e-16, -3.6e-16, -2.3999999999999996e-16, -1.1999999999999998e-16, 0.0, 1.2000000000000008e-16, 2.4000000000000005e-16, 3.6000000000000003e-16, 4.8e-16, 6e-16]

fgt2

1500:
[0.8725903085000001, 0.8710905141999999, 0.8701067690999998, 0.8694494382999999, 0.8687095895999999, 0.8685616985, 0.8693811518, 0.8692373814, 0.8702582585000002, 0.8708664559, 0.8727168165]
[-3e-12, -2.4000000000000003e-12, -1.8000000000000002e-12, -1.2000000000000001e-12, -6.000000000000003e-13, -4.0389678347315804e-28, 5.999999999999999e-13, 1.1999999999999997e-12, 1.7999999999999996e-12, 2.3999999999999995e-12, 2.9999999999999993e-12]

5000:
[1.4546121892600006, 1.4557449947599999, 1.4552088717, 1.4547181336300001, 1.4549972287600001, 1.4545246348199998, 1.4549044750399998, 1.4553595287199996, 1.4553114414, 1.4555292078, 1.45642006759]
[-3e-14, -2.4e-14, -1.8e-14, -1.2e-14, -6e-15, 0.0, 6e-15, 1.2e-14, 1.8e-14, 2.4e-14, 3e-14]

7000:
[1.61005977089, 1.6094167820500005, 1.60904682619, 1.6089965655199998, 1.6082602748699997, 1.6083697073100003, 1.6088240085099998, 1.6083991142799998, 1.6084481790599998, 1.6086399212100002, 1.6087635173500003]
[-1.2e-14, -9.6e-15, -7.2e-15, -4.799999999999999e-15, -2.3999999999999996e-15, 0.0, 2.400000000000001e-15, 4.799999999999999e-15, 7.2e-15, 9.600000000000001e-15, 1.2e-14]

15000:
[1.90077467156, 1.90107692924, 1.8999782948300004, 1.8999469464000003, 1.8985055781500002, 1.8997281884, 1.8985561031899998, 1.8984564584699997, 1.8993637457999997, 1.8992981476, 1.90067898115]
[-1.2e-15, -9.6e-16, -7.2e-16, -4.799999999999999e-16, -2.3999999999999996e-16, 0.0, 2.4000000000000015e-16, 4.800000000000001e-16, 7.200000000000001e-16, 9.6e-16, 1.2e-15]

fgt3

1500:
[0.872913568, 0.8713233732, 0.8703941601999997, 0.8696711547, 0.8687782434, 0.8689317255, 0.8687208670000002, 0.8695985667999999, 0.869934784, 0.8714897576, 0.8726935177999999]
[-3e-12, -2.4000000000000003e-12, -1.8000000000000002e-12, -1.2000000000000001e-12, -6.000000000000003e-13, -4.0389678347315804e-28, 5.999999999999999e-13, 1.1999999999999997e-12, 1.7999999999999996e-12, 2.3999999999999995e-12, 2.9999999999999993e-12]

5000:
[1.4556476743600002, 1.45554652599, 1.45562303022, 1.45538615971, 1.4540996911300001, 1.4551894923700002, 1.45527427376, 1.45536479923, 1.45572942599, 1.4557464210100006, 1.4559840349499995]
[-3e-14, -2.4e-14, -1.8e-14, -1.2e-14, -6e-15, 0.0, 6e-15, 1.2e-14, 1.8e-14, 2.4e-14, 3e-14]

7000:
[1.6099505178099998, 1.6092171735700005, 1.60949892456, 1.60842981131, 1.6087235047, 1.60875317509, 1.6081786503500002, 1.6089885593999997, 1.60855016831, 1.6101461478699994, 1.6102339479100007]
[-1.2e-14, -9.6e-15, -7.2e-15, -4.799999999999999e-15, -2.3999999999999996e-15, 0.0, 2.400000000000001e-15, 4.799999999999999e-15, 7.2e-15, 9.600000000000001e-15, 1.2e-14]

15000:
[1.9007979676500004, 1.89964504862, 1.90003834536, 1.8995444549300002, 1.8995169066700002, 1.8985286962699996, 1.8998432995699999, 1.8991684757400005, 1.8987956534300001, 1.8998291887999998, 1.8999795463499998]
[-1.2e-15, -9.6e-16, -7.2e-16, -4.799999999999999e-16, -2.3999999999999996e-16, 0.0, 2.4000000000000015e-16, 4.800000000000001e-16, 7.200000000000001e-16, 9.6e-16, 1.2e-15]

"""