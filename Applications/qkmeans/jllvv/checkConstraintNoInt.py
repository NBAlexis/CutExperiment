import os

import numpy as np
from scipy.optimize import curve_fit

thresh = 0.55

# validationcounts = [20000, 20000, 20000, 19445, 20000, 6546, 20000, 887, 141, 1256, 814, 258, 13628, 9363]
#ã€€validationcounts = [30000, 30000, 16262, 12277, 30000, 6546, 20075, 887, 141, 1256, 814, 258, 13628, 9363]
validationcounts = [30000, 30000, 13472, 16245, 12272, 30000, 6543, 20071, 887, 139, 1256, 813, 257, 13520, 9307, 22, 163, 18697]
L = 140
trainset = ["ft0", "ggwwnp", "ajllvvnp", "sm",
            "tt", "jjllvv", "ttj", "ttjj",
            "ttjjj", "jll", "jjll", "jjjll",
            "jjjjll", "jlllv", "jlllvb", "ajll",
            "ajjll", "ajllvv"]
"""
ft0      427724 / 902883  0.07033523769312358 / 0.148470720404
ggwwnp   446996 / 1000000  0.06923430075477707 / 0.15488796489180456
ajllvvnp 17568 / 44382  0.006879493711020082 / 0.01737964992500531

jllvv    24437 / 2000000  0.014014828715093419 / 1.1470171228132273
jjllvv   49787 / 2000000  0.0 / 0.7 (0.01742545)

tt       20464 / 5100000  0.1010675673257054 / 25.187871059475057
ttj      6543 / 1147221  0.16199065227396697 / 28.40273239987661
ttjj     20071 / 2556974  0.16454374744782152 / 20.962288081642466
ttjjj    887 / 100000  0.10919607441384768 / 12.310718648686324

jll      139 / 9501000  0.0072943596135588125 / 498.58784667929694
jjll     1256 / 15756073  0.01657523181827877 / 207.9303841725502
jjjll    813 / 4000000  0.017130141879617266 / 84.28114085912553
jjjjll   257 / 812683  0.010392097581532946 / 32.86179392549782

jlllv    13520 / 2501000  0.0005735141233029315 / 0.10609162887430708
jlllvb   9307 / 3001000  0.00021788534400341174 / 0.07025614240402263

ajll     22 / 2281263  6.28110723740789e-05 / 6.513117063514017
ajjll    163 / 2000000  0.00023262742266023 / 2.85432420442
ajllvv   18697 / 1001237  0.0003529662955632318 / 0.018901583937040355

trainset = ["ft0", "ggwwnp", "ajllvvnp", "sm",
            "tt", "jjllvv", "ttj", "ttjj",
            "ttjjj", "jll", "jjll", "jjjll",
            "jjjjll", "jlllv", "jlllvb", "ajll",
            "ajjll", "ajllvv"]
"""
tttowb = 888000 * 0.23 * 0.23 * 12.310718648686324 / 249.25127345975994
css = [70.33523769312358,  # ft0
       69.23430075477707,  # ggwwnp
       6.879493711020082,  # ajllvvnp

       14.014828715093419,  # SM
       tttowb * 20464 / 5100000,  # tt
       720.1 * 49787 / 2000000,  # jjllvv
       tttowb * 6543 / 1147221,  # ttj
       tttowb * 20071 / 2556974,  # ttjj
       tttowb * 887 / 100000,  # ttjjj

       7.2943596135588125,  # jll
       16.57523181827877,  # jjll
       17.130141879617266,  # jjjll
       10.392097581532946,  # jjjjll

       0.5735141233029315,  # jlllv
       0.21788534400341174,  # jlllvb

       6.28110723740789e-02, # ajll
       0.23262742266023,     # ajjll
       0.3529662955632318    # ajllvv
       ]

includedtype = [
    1,  # ft0
    1,  # ggwwnp
    1,  # ajllvvnp

    2,  # SM
    2,  # tt

    2,  # jjllvv
    0,  # ttj
    0,  # ttjj
    0,  # ttjjj

    0,  # jll
    2,  # jjll
    2,  # jjjll
    2,  # jjjjll

    2,  # jlllv
    2,  # jlllvb

    2,  # ajll
    2,  # ajjll
    2   # ajllvv
]

css = np.array(css)
includedtype = np.array(includedtype)

os.chdir("../../../_DataFolder/qkmeans/jllvv/")

validationres = np.loadtxt("wfv5/validationv5-16384-l8-5000-01.csv", delimiter=',')

allcs = []
bgcs = 0
sigcs = 0
nstart = 0
for i in range(len(validationcounts)):
    c = validationcounts[i]
    s = validationres[nstart:nstart + c]
    sAbove = None
    if len(np.shape(s)) > 1:
        sAbove = len(s[s[:, 0] > thresh, 0])
    else:
        sAbove = len(s[s > thresh])
    cs = css[i] * sAbove / c
    allcs.append(cs)
    if 1 == includedtype[i]:
        sigcs = sigcs + cs
    if 2 == includedtype[i]:
        bgcs = bgcs + cs
    nstart = nstart + c

print(trainset)
print(css.tolist())
print(allcs)
print("signal")
print(sigcs)
print("background")
print(bgcs)

ss = 2
right = (np.sqrt((2 * sigcs * (ss ** 2 + np.sqrt(4 * bgcs * L * ss ** 2 + ss ** 4))) / L)) / (2 * sigcs)

print("constraint")
print(right)

print("mass")
print((1 / (16 * right)) ** (0.25))

"""
2048-l5
thresh=0.5

['ft0', 'ggwwnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb']
[70.73844631 69.61145295 14.02457836  9.31196013 17.9384111  13.23864604
 18.21561757 20.5796639   7.39931443 16.57523182 17.15121216 13.42481088
  0.57809545  0.21919635]
[34.230334169837434, 33.04107614237984, 0.1381420968522777, 0.047888712419368776, 0.27625153094, 0.09100810752833216, 0.1994610123939009, 0.2088128242535215, 0.31486444375074013, 0.2507399717733253, 0.37926513386606486, 0.26017075355691327, 0.009289910725099259, 0.003862800232143863]
signal
67.27141031221728
background
1.3656109103651932
constraint
0.05650837777781688
mass
1.0255144740623807

2048-ae
thresh=0.6
['ft0', 'ggwwnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb']
[70.73844631 69.61145295 14.02457836  9.31196013 17.9384111  13.23864604
 18.21561757 20.5796639   7.39931443 16.57523182 17.15121216 13.42481088
  0.57809545  0.21919635]
[33.42037895957779, 30.79958735741275, 0.08204378340972839, 0.020113259216134886, 0.08610437328000001, 0.01617921911614794, 0.011840151420642521, 0.0, 0.26238703645895006, 0.3167241748715689, 0.23177313736259522, 0.10406830142276531, 0.0006362952551437848, 0.0004916291204546734]
signal
64.21996631699054
background
0.841954953938391
constraint
0.051762049561710606
mass
1.048255472312523



16384-l5
thresh=0.35
['ft0', 'ggwwnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb']
[70.73844631 69.61145295 14.02457836  9.31196013 17.9384111  13.23864604
 18.21561757 20.5796639   7.39931443 16.57523182 17.15121216 13.42481088
  0.57809545  0.21919635]
[41.66258692890111, 40.228458659393894, 0.18714386325533763, 0.0379244120304075, 0.2738597427933333, 0.04449285256940684, 0.09799684670404385, 0.11600712458528972, 0.47229666562611017, 0.2903304936322714, 0.2528434225773766, 0.20813660284553062, 0.00984136661289054, 0.003488225664178397]
signal
81.89104558829501
background
1.2635681294113261
constraint
0.05001214983766318
mass
1.0573070387482602

16384-ae
thresh=0.6
['ft0', 'ggwwnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb']
[70.73844631 69.61145295 14.02457836  9.31196013 17.9384111  13.23864604
 18.21561757 20.5796639   7.39931443 16.57523182 17.15121216 13.42481088
  0.57809545  0.21919635]
[31.440881436978184, 28.396832039779806, 0.05950657403049907, 0.01289430009033855, 0.06936185625333333, 0.01617921911614794, 0.010888538522671538, 0.0, 0.31486444375074013, 0.15836208743578445, 0.10535142607390692, 0.0, 0.00025451810205751393, 4.6821820995683185e-05]
signal
59.83771347675799
background
0.4057775838069155
constraint
0.04532041162011401
mass
1.0836687330807369

16384-classical
['ft0', 'ggwwnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb']
[70.73844631 69.61145295 14.02457836  9.31196013 17.9384111  13.23864604
 18.21561757 20.5796639   7.39931443 16.57523182 17.15121216 13.42481088
  0.57809545  0.21919635]
[60.820916138099236, 58.54091154858675, 0.8365416928925231, 0.31173866688994967, 0.9046938664766666, 0.48335417109491974, 0.5988696187469347, 0.6728413225946804, 1.2069803677111706, 1.8607545273704669, 1.8963256693303245, 1.4569562199187145, 0.0218885567769462, 0.0075617240908028354]
signal
119.36182768668598
background
7.296460923746395
constraint
0.06282338759769443
mass
0.998710616625235


16384-v5-l8: 0.55
['ft0', 'ggwwnp', 'ajllvvnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb', 'ajll', 'ajjll', 'ajllvv']
[70.33523769312357, 69.23430075477707, 6.879493711020082, 14.014828715093419, 9.309685480444585, 17.92580935, 13.232578834619499, 18.211988057378374, 20.579663901430397, 7.294359613558813, 16.57523181827877, 17.130141879617266, 10.392097581532946, 0.5735141233029315, 0.21788534400341175, 0.0628110723740789, 0.23262742266023, 0.3529662955632318]
[35.82408106503094, 34.557147316734394, 3.6215387023867596, 0.17858230495686905, 0.05917172974858846, 0.26888714025000005, 0.06673927885411027, 0.13882886616406212, 0.09280569966823178, 0.7346837020850603, 0.5542673060252454, 0.5056868451547533, 0.40436177360050374, 0.01200477048037941, 0.004541716636581271, 0.0028550487442763135, 0.00856297261326, 0.006173181721622549]
signal
74.0027670841521
background
2.00509478993208
constraint
0.05859297997144529
mass
1.0162688352313798



16384-v7-l8: 0.65
['ft0', 'ggwwnp', 'ajllvvnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb', 'ajll', 'ajjll', 'ajllvv']
[70.33523769312357, 69.23430075477707, 6.879493711020082, 14.014828715093419, 9.309685480444585, 17.92580935, 13.232578834619499, 18.211988057378374, 20.579663901430397, 7.294359613558813, 16.57523181827877, 17.130141879617266, 10.392097581532946, 0.5735141233029315, 0.21788534400341175, 0.0628110723740789, 0.23262742266023, 0.3529662955632318]
[37.10418239104579, 35.664896128810824, 4.167424894272186, 0.10093782454083904, 0.00910334303824438, 0.13205346221166667, 0.016179219116147944, 0.01724018599422994, 0.0, 0.36734185104253014, 0.3695115373501637, 0.40033541908084636, 0.24261706416030226, 0.003690512479833953, 0.001872872839827328, 0.0, 0.00713581051105, 0.009174820540393147]
signal
76.9365034141288
background
1.276432666753167
constraint
0.05171839881492053
mass
1.0484765863652377

16384-v7-l10: 0.7
['ft0', 'ggwwnp', 'ajllvvnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb', 'ajll', 'ajjll', 'ajllvv']
[70.33523769312357, 69.23430075477707, 6.879493711020082, 14.014828715093419, 9.309685480444585, 17.92580935, 13.232578834619499, 18.211988057378374, 20.579663901430397, 7.294359613558813, 16.57523181827877, 17.130141879617266, 10.392097581532946, 0.5735141233029315, 0.21788534400341175, 0.0628110723740789, 0.23262742266023, 0.3529662955632318]
[31.050662933590953, 29.79613523483089, 3.721626348420009, 0.07419361461976202, 0.0053102834389758885, 0.07947108811833334, 0.010112011947592465, 0.004536891051113142, 0.0, 0.36734185104253014, 0.23754313115367665, 0.23177313736259525, 0.040436177360050375, 0.0021209841838126164, 0.0010300800619050302, 0.0, 0.00713581051105, 0.007305875615498245]
signal
64.56842451684184
background
0.6863201824256593
constraint
0.0490025919711931
mass
1.0627111597564733

16384-v7-ae: 0.6
['ft0', 'ggwwnp', 'ajllvvnp', 
'sm', 'tt', 'jjllvv', 
'ttj', 'ttjj', 'ttjjj', 'jll', 
'jjll', 'jjjll', 'jjjjll', 
'jlllv', 'jlllvb', 'ajll', 'ajjll', 'ajllvv']
[70.33523769312357, 69.23430075477707, 6.879493711020082, 14.014828715093419, 9.309685480444585, 17.92580935, 13.232578834619499, 18.211988057378374, 20.579663901430397, 7.294359613558813, 16.57523181827877, 17.130141879617266, 10.392097581532946, 0.5735141233029315, 0.21788534400341175, 0.0628110723740789, 0.23262742266023, 0.3529662955632318]
[30.537215698431154, 28.93070647539618, 4.064783991962578, 
0.06384101723095802, 0.00455167151912219, 0.06393538668166668, 
0.008089609558073972, 0.008166403892003654, 0.0, 0.7346837020850603, 
0.4486925810680559, 0.2949839930069394, 0.1617447094402015, 
0.0016119479796975885, 0.0011003127933985552, 0.0, 0.00713581051105, 0.007796709636177715]
signal
63.53270616578991
background
1.0553941398672677
constraint
0.054473096910213945
mass
1.034962198546077

KNN-K1
['ft0', 'ggwwnp', 'ajllvvnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb', 'ajll', 'ajjll', 'ajllvv']
[70.33523769312357, 69.23430075477707, 6.879493711020082, 14.014828715093419, 9.309685480444585, 17.92580935, 13.232578834619499, 18.211988057378374, 20.579663901430397, 7.294359613558813, 16.57523181827877, 17.130141879617266, 10.392097581532946, 0.5735141233029315, 0.21788534400341175, 0.0628110723740789, 0.23262742266023, 0.3529662955632318]
[64.06602350674316, 62.931671576067195, 6.455142517889316, 1.1430992950137753, 0.3087550513804552, 1.23329568328, 0.4530181352521424, 0.5380752786620185, 0.3944242235899851, 2.204051106255181, 2.7185491676476325, 2.5916450814181102, 1.3343938528816623, 0.048103921288870144, 0.019314001160719317, 0.02284038995421051, 0.04852351147514, 0.060976687953641695]
signal
133.4528376006997
background
9.529496643454216
constraint
0.06339147803092303
mass
0.9964655410196874

KNN-K10
['ft0', 'ggwwnp', 'ajllvvnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb', 'ajll', 'ajjll', 'ajllvv']
[70.33523769312357, 69.23430075477707, 6.879493711020082, 14.014828715093419, 9.309685480444585, 17.92580935, 13.232578834619499, 18.211988057378374, 20.579663901430397, 7.294359613558813, 16.57523181827877, 17.130141879617266, 10.392097581532946, 0.5735141233029315, 0.21788534400341175, 0.0628110723740789, 0.23262742266023, 0.3529662955632318]
[65.49148432399046, 64.3071263510621, 6.5511449538803905, 0.8049144469795112, 0.18889436804357088, 0.8610363757783334, 0.20830744612040478, 0.2504363860214454, 0.2088128242535215, 2.0990962916716005, 2.560187080211848, 1.917395954545106, 1.0513406113613097, 0.027700053440592773, 0.01231413892186468, 0.019985341209934195, 0.04566918727072, 0.055653026652425906]
signal
136.34975562893294
background
7.545090584415217
constraint
0.059258700445789195
mass
1.0134025052043811

KNN-K100
['ft0', 'ggwwnp', 'ajllvvnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb', 'ajll', 'ajjll', 'ajllvv']
[70.33523769312357, 69.23430075477707, 6.879493711020082, 14.014828715093419, 9.309685480444585, 17.92580935, 13.232578834619499, 18.211988057378374, 20.579663901430397, 7.294359613558813, 16.57523181827877, 17.130141879617266, 10.392097581532946, 0.5735141233029315, 0.21788534400341175, 0.0628110723740789, 0.23262742266023, 0.3529662955632318]
[63.41893931996642, 62.0200866161293, 6.398460228554158, 0.5719810057314211, 0.11682623565746954, 0.5760160071133335, 0.1152769362025541, 0.1442731354253979, 0.1624099744194056, 1.6267996260454907, 1.7947703242722235, 1.643482246752948, 0.8895959019211083, 0.015525604225508353, 0.007280793164828737, 0.014275243721381569, 0.029970404146409998, 0.04175864822088403]
signal
131.83748616464987
background
5.701482414927516
constraint
0.05631768640342319
mass
1.0263814705536534

KNN-K1000
['ft0', 'ggwwnp', 'ajllvvnp', 'sm', 'tt', 'jjllvv', 'ttj', 'ttjj', 'ttjjj', 'jll', 'jjll', 'jjjll', 'jjjjll', 'jlllv', 'jlllvb', 'ajll', 'ajjll', 'ajllvv']
[70.33523769312357, 69.23430075477707, 6.879493711020082, 14.014828715093419, 9.309685480444585, 17.92580935, 13.232578834619499, 18.211988057378374, 20.579663901430397, 7.294359613558813, 16.57523181827877, 17.130141879617266, 10.392097581532946, 0.5735141233029315, 0.21788534400341175, 0.0628110723740789, 0.23262742266023, 0.3529662955632318]
[58.53767382406365, 57.418313425961784, 6.038451093587624, 0.3381848480342641, 0.05462005822946628, 0.3346151078666667, 0.04651525495892534, 0.05897958366447085, 0.06960427475117384, 1.3644125895865407, 1.1217314526701396, 1.0113736903095065, 0.6874150151208563, 0.007168926541286644, 0.003745745679654656, 0.005710097488552627, 0.01998026943094, 0.0209359588051358]
signal
121.99443834361306
background
3.605481170176469
constraint
0.05244640741422611
mass
1.0448190159313309

"""